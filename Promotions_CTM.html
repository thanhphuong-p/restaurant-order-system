<!DOCTYPE html>
<html lang="vi" ng-app="promotionApp">
<head>
  <meta charset="UTF-8">
  <title>Ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- AngularJS & Bootstrap JS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
 /* Header */
 header {
      background: #fff8dc;
      padding: 20px 0;
      border-bottom: 2px solid #f1c40f;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo img {
      height: 60px;
      margin-right: 15px;
    }
        /* Logo */
.logo_donghanh {
    position: absolute;
    left: 30px; /* ƒê∆∞a logo sang tr√°i c√°ch 100px */
}

.logo_donghanh img {
    width: 80px;
    height: auto;
    border-radius: 50%;
}

    .logo h1 {
      font-size: 28px;
      color: #e67e22;
      font-weight: bold;
      margin: 0;
    }

    h2 {
      color: #d35400;
      margin: 30px 0;
      text-align: center;
    }

    .card-img-top {
      height: 180px;
      object-fit: cover;
    }
    .text-truncate-description {
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      line-clamp: 4;
      -webkit-box-orient: vertical;
    }
    .countdown {
      font-weight: bold;
      color: #dc3545;
    }
    .cart-icon {
      position: fixed;
      top: 20px;
      right: 30px;
      z-index: 999;
      font-size: 24px;
      cursor: pointer;
    }
    .cart-count {
      position: absolute;
      top: -8px;
      right: -10px;
      background-color: red;
      color: white;
      border-radius: 50%;
      padding: 3px 7px;
      font-size: 12px;
    }
    nav {
  background: #e17f1e;
  border-bottom: 2px solid #ff6f00;
  padding: 0;
  color: #e67e22;
}

.navbar-nav {
  display: flex;
  justify-content: center;
  border-bottom: 2px solid #f7a558;
}

.nav-link {
  color: #d35400; /* m√†u cam ƒë·∫≠m */
  padding: 12px 20px;
  font-weight: bold; /* in ƒë·∫≠m m·∫∑c ƒë·ªãnh */
  font-size: 16px;
  transition: all 0.3s ease;
}

.nav-link:hover,
.nav-link.active {
  color: #000; /* m√†u ƒëen khi nh·∫•n ho·∫∑c hover */
  border-bottom: 3px solid #000;
  /* font-weight: normal; */ /* n·∫øu mu·ªën kh√¥ng in ƒë·∫≠m khi nh·∫•n */
}
.cart-icon {
      position: fixed;
      top: 20px;
      right: 30px;
      background: #e67e22;
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    }

  </style>
</head>

<body ng-controller="PromotionController">
 
  <!-- Gi·ªè h√†ng n·ªïi -->
  <div class="cart-icon" data-bs-toggle="modal" data-bs-target="#invoiceModal">
    üõí {{cart.length}} | {{getTotal() | number}}ƒë
  </div>

 <!-- Header + Logo -->
 <header>
  <a class="logo_donghanh" href="#home">
    <img src="img/logo.png" alt="Logo">
</a>
  <div class="container logo">
    <img src="https://cdn-icons-png.flaticon.com/512/3480/3480381.png" alt="Logo">
    <h1>Food Order App</h1>
  </div>
</header>
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand text-warning fw-bold" href="#">Menu</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="menu.html?category=food" ng-class="{active: selectedCategory === 'food'}" ng-click="loadCategory('food')">M√≥n Ch√≠nh</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="menu.html?category=drink" ng-class="{active: selectedCategory === 'drink'}" ng-click="loadCategory('drink')">N∆∞·ªõc U·ªëng</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="Promotions_CTM.html" ng-class="{active: selectedCategory === 'combo'}" ng-click="loadCategory('combo')">Combo Sale</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- Danh s√°ch khuy·∫øn m√£i -->
  <div class="container py-4">
    <h2 class="text-center mb-4">üéâ C√°c ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i</h2>
    <div class="row row-cols-1 row-cols-md-3 g-4">
      <div class="col" ng-repeat="promo in promotions" ng-if="promo.status === true">
        <div class="card h-100 shadow-sm d-flex flex-column">
          <img ng-src="{{promo.image}}" class="card-img-top" alt="{{promo.name}}">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{promo.name}}</h5>
            <p class="card-text text-truncate-description">{{promo.description}}</p>
            <p class="fw-bold text-danger fs-4 mt-auto">{{promo.price | number:0}}‚Ç´</p>
            <p><small>√Åp d·ª•ng: {{promo.startDate | date:'dd/MM/yyyy'}} - {{promo.endDate | date:'dd/MM/yyyy'}}</small></p>
            <p class="countdown">{{ promo.remainingTime }}</p>
            <button class="btn btn-success w-100 mt-2" ng-click="addToCart(promo)">‚ûï Th√™m v√†o gi·ªè</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Gi·ªè h√†ng -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üõçÔ∏è Gi·ªè h√†ng c·ªßa b·∫°n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered" ng-if="cart.length > 0">
            <thead class="table-light">
              <tr>
                <th>H√¨nh ·∫£nh</th>
                <th>T√™n</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Th√†nh ti·ªÅn</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in cart">
                <td><img ng-src="{{item.image}}" style="height: 60px;"></td>
                <td>{{item.name}}</td>
                <td>{{item.price | number:0}}‚Ç´</td>
                <td><input type="number" class="form-control" ng-model="item.quantity" min="1" ng-change="updateTotal()" style="width: 70px;"></td>
                <td>{{item.price * item.quantity | number:0}}‚Ç´</td>
                <td><button class="btn btn-danger btn-sm" ng-click="removeFromCart(item)">X√≥a</button></td>
              </tr>
            </tbody>
          </table>
          <div class="text-center text-muted" ng-if="cart.length === 0">üõí Gi·ªè h√†ng tr·ªëng.</div>
        </div>
        <div class="modal-footer justify-content-between">
          <h5 class="mb-0">T·ªïng ti·ªÅn: <span class="text-danger">{{getTotal() | number:0}}‚Ç´</span></h5>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tableModal">Ch·ªçn B√†n</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Ch·ªçn b√†n -->
  <div class="modal fade" id="tableModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üçΩÔ∏è Ch·ªçn B√†n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-3" ng-repeat="table in tables">
              <div class="card text-center"
                   ng-click="selectTable(table)"
                   ng-style="{
                     'background-color': table.status === 'TRONG' ? '#28a745' : '#dc3545',
                     'color': 'white',
                     'cursor': 'pointer',
                     'border-radius': '12px'
                   }"
                   onmouseover="this.style.transform='scale(1.05)'"
                   onmouseout="this.style.transform='scale(1)'">
                <div class="card-body py-4">
                  <h5 class="card-title">B√†n {{table.name}}</h5>
                  <p>
                    <i class="bi"
                       ng-class="{
                         'bi-check-circle-fill text-white': table.status === 'TRONG',
                         'bi-exclamation-circle-fill text-white': table.status !== 'TRONG'
                       }"></i>
                    {{ table.status === 'TRONG' ? 'Tr·ªëng' : 'ƒêang ho·∫°t ƒë·ªông' }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <span>üîò B√†n ƒë√£ ch·ªçn: <strong class="text-primary">{{ selectedTable.name || 'Ch∆∞a ch·ªçn' }}</strong></span>
          <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: H√≥a ƒë∆°n -->
  <div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üßæ H√≥a ƒê∆°n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h5>B√†n: {{ selectedTable.tableNumber}}</h5>
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>T√™n M√≥n</th>
                <th>S·ªë L∆∞·ª£ng</th>
                <th>Gi√°</th>
                <th>Th√†nh Ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="item in cart">
                <td>{{ item.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.price | number:0 }}‚Ç´</td>
                <td>{{ item.price * item.quantity | number:0 }}‚Ç´</td>
              </tr>
            </tbody>
          </table>
          <h4 class="text-end">T·ªïng c·ªông: <span class="text-danger">{{ getTotal() | number:0 }}‚Ç´</span></h4>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button class="btn btn-primary" ng-click="confirmOrder()">X√°c Nh·∫≠n ƒê·∫∑t H√†ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AngularJS Script -->
  <script>
    var app = angular.module('promotionApp', []);
    app.controller('PromotionController', function($scope, $http, $interval) {
      $scope.promotions = [];
      $scope.cart = JSON.parse(localStorage.getItem("cart")) || [];
      $scope.tables = [];
      $scope.selectedTable = JSON.parse(localStorage.getItem("selectedTable")) || {};
    
      // Load khuy·∫øn m√£i
      $scope.getPromotions = function() {
        $http.get('http://localhost:8081/api/promotions')
          .then(res => $scope.promotions = res.data)
          .catch(err => console.error('L·ªói khuy·∫øn m√£i:', err));
      };
    
      // Load b√†n
      $scope.getTables = function() {
        $http.get('http://localhost:8081/api/tables')
          .then(res => $scope.tables = res.data)
          .catch(err => console.error('L·ªói b√†n:', err));
      };
    
      // Th√™m v√†o gi·ªè
      $scope.addToCart = function(promo) {
        let item = $scope.cart.find(i => i.id === promo.id);
        if (item) {
          item.quantity += 1;
        } else {
          $scope.cart.push({ ...promo, quantity: 1 });
        }
        $scope.saveCart();
      };
    
      // X√≥a kh·ªèi gi·ªè
      $scope.removeFromCart = function(item) {
        let index = $scope.cart.indexOf(item);
        if (index > -1) {
          $scope.cart.splice(index, 1);
          $scope.saveCart();
        }
      };
    
      // T√≠nh t·ªïng ti·ªÅn
      $scope.getTotal = function() {
        return $scope.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      };
    
      // C·∫≠p nh·∫≠t t·ªïng
      $scope.updateTotal = function() {
        $scope.saveCart();
      };
    
      // Ch·ªçn b√†n
      $scope.selectTable = function(table) {
        $scope.selectedTable = table;
        localStorage.setItem("selectedTable", JSON.stringify($scope.selectedTable));
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
      };
    
      // X√°c nh·∫≠n ƒë·∫∑t h√†ng (c√≥ th·ªÉ g·ª≠i v·ªÅ API ·ªü ƒë√¢y n·∫øu c·∫ßn)
      $scope.confirmOrder = function() {
        if (!$scope.selectedTable.id || $scope.cart.length === 0) {
          alert("Vui l√≤ng ch·ªçn b√†n v√† s·∫£n ph·∫©m!");
          return;
        }
    
        const order = {
          tableId: $scope.selectedTable.id,
          items: $scope.cart.map(i => ({
            foodId: i.id,
            quantity: i.quantity
          }))
        };
    
        $http.post('http://localhost:8081/api/orders', order)
          .then(res => {
            alert("‚úÖ ƒê·∫∑t m√≥n th√†nh c√¥ng!");
            $scope.cart = [];
            localStorage.removeItem("cart");
            $scope.getTables();
            bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
          })
          .catch(err => {
            alert("‚ùå L·ªói ƒë·∫∑t h√†ng!");
            console.error(err);
          });
      };
    
      // L∆∞u gi·ªè h√†ng v√†o localStorage
      $scope.saveCart = function() {
        localStorage.setItem("cart", JSON.stringify($scope.cart));
      };
    
      // ƒê·∫øm ng∆∞·ª£c th·ªùi gian khuy·∫øn m√£i
      function updateCountdown() {
        const now = new Date().getTime();
        $scope.promotions.forEach(p => {
          const end = new Date(p.endDate).getTime();
          const distance = end - now;
          if (distance > 0) {
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            p.remainingTime = `${days} ng√†y ${hours} gi·ªù ${minutes} ph√∫t`;
          } else {
            p.remainingTime = "ƒê√£ k·∫øt th√∫c";
          }
        });
      }
    
      $interval(updateCountdown, 60000); // C·∫≠p nh·∫≠t m·ªói ph√∫t
      $scope.getPromotions();
      $scope.getTables();
      updateCountdown(); // c·∫≠p nh·∫≠t l·∫ßn ƒë·∫ßu
    });
    </script>
    

</body>
</html>
